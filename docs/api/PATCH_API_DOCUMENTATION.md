# Git Diff Patch API Documentation

## Overview
The Scala Runner API now supports applying git diff patches to workspace files using the `PATCH /files` endpoint. This allows you to apply changes using standard git diff output instead of replacing entire file contents.

## Endpoint Details

### `PATCH /files`
Apply a git diff patch to workspace files.

**Request Body:**
```json
{
    "workspace_name": "my-workspace",
    "patch": "--- a/src/main/scala/Example.scala\n+++ b/src/main/scala/Example.scala\n@@ -1,3 +1,4 @@\n object Example {\n+  val newVar = \"hello\"\n   def main(args: Array[String]): Unit = {\n     println(\"Hello World\")"
}
```

**Response:**
```json
{
    "status": "success",
    "data": {
        "workspace_name": "my-workspace",
        "patch_applied": true,
        "results": {
            "modified_files": [
                {
                    "file_path": "src/main/scala/Example.scala",
                    "status": "success",
                    "hunks_applied": 1
                }
            ],
            "total_files": 1,
            "successful_files": 1
        }
    }
}
```

## Supported Git Diff Formats

### Standard Unified Diff
The API supports standard unified diff format as generated by `git diff`:

```diff
--- a/src/main/scala/HelloWorld.scala
+++ b/src/main/scala/HelloWorld.scala
@@ -1,7 +1,9 @@
 object HelloWorld {
   def main(args: Array[String]): Unit = {
-    println("Hello, World!")
+    println("Hello, Patched World!")
     val x = 1
     val y = 2
-    println(s"Result: ${x + y}")
+    val z = 3
+    println(s"Result: ${x + y + z}")
   }
 }
```

### Multiple Files
You can apply patches to multiple files in a single request:

```diff
--- a/file1.scala
+++ b/file1.scala
@@ -1,3 +1,3 @@
 object File1 {
-  val old = "value"
+  val new = "value"
 }
--- a/file2.scala
+++ b/file2.scala
@@ -1,3 +1,4 @@
 object File2 {
   def method(): Unit = {
+    println("New line")
   }
 }
```

## Usage Examples

### Example 1: Simple Line Change
```bash
curl -X PATCH "http://localhost:8000/files" \
  -H "Content-Type: application/json" \
  -d '{
    "workspace_name": "my-project",
    "patch": "--- a/Main.scala\n+++ b/Main.scala\n@@ -1,3 +1,3 @@\n object Main {\n-  println(\"old\")\n+  println(\"new\")\n }"
  }'
```

### Example 2: Adding New Code
```bash
curl -X PATCH "http://localhost:8000/files" \
  -H "Content-Type: application/json" \
  -d '{
    "workspace_name": "my-project", 
    "patch": "--- a/Utils.scala\n+++ b/Utils.scala\n@@ -5,0 +6,3 @@\n+\n+  def newMethod(): String = {\n+    \"Hello from patch\"\n+  }"
  }'
```

### Example 3: Creating New File
```bash
curl -X PATCH "http://localhost:8000/files" \
  -H "Content-Type: application/json" \
  -d '{
    "workspace_name": "my-project",
    "patch": "--- /dev/null\n+++ b/NewFile.scala\n@@ -0,0 +1,5 @@\n+object NewFile {\n+  def main(args: Array[String]): Unit = {\n+    println(\"Created via patch!\")\n+  }\n+}"
  }'
```

## Response Format

### Success Response
```json
{
    "status": "success",
    "data": {
        "workspace_name": "my-workspace",
        "patch_applied": true,
        "results": {
            "modified_files": [
                {
                    "file_path": "path/to/file.scala",
                    "status": "success",
                    "hunks_applied": 2
                }
            ],
            "total_files": 1,
            "successful_files": 1
        }
    }
}
```

### Error Response
```json
{
    "status": "error",
    "detail": "Failed to apply patch: Invalid hunk format"
}
```

## Error Handling

The API handles various error conditions:

- **Invalid workspace**: Returns 400 if workspace doesn't exist
- **Malformed patch**: Returns 400 if patch format is invalid
- **File not found**: Creates new files if they don't exist
- **Patch conflicts**: Returns detailed error information

## Integration with Existing Features

- **Search Indexing**: Modified files are automatically re-indexed for search
- **File Tree**: Changes are reflected in the workspace file tree
- **Git Integration**: Works alongside existing git operations

## Comparison with PUT /files

| Feature | PATCH /files (Git Diff) | PUT /files (Full Replace) |
|---------|------------------------|---------------------------|
| Update method | Applies specific changes | Replaces entire content |
| Multiple files | ✅ Supported | ❌ One file per request |
| Precision | ✅ Line-level changes | ❌ Full file replacement |
| Git workflow | ✅ Native git diff format | ❌ Custom format |
| Conflict detection | ✅ Context-aware | ❌ No conflict detection |

Use `PATCH /files` when you want to apply specific changes (like from git diff output) and `PUT /files` when you want to replace the entire file content. 